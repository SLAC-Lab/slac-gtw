<?php
/**
 * @file
 * Code for the SLAC IGP Email feature.
 */

include_once 'slac_igp_email.features.inc';
define('VIEW_MODE_TEASER', 'teaser');
define('VIEW_MODE_LINK', 'link');
define('DIRECTOR_COLUMN', 'DIRECTOR\'S COLUMNS');

/**
 * Implements hook_field_formatter_info
 */
function slac_igp_email_field_formatter_info() {
  return array(
    'link_image' => array(
      'label' => t('URL, as rendered image'),
      'field types' => array('link_field'),
      // 'multiple values' => FIELD_BEHAVIOR_DEFAULT,
    ),
  );  
}

/**
 * Implements hook_field_formatter_view().
 */
function slac_igp_email_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $elements = array();
  foreach ($items as $delta => $item) {
    if ($display['type'] == 'link_image') {
      $elements[$delta] = array(
        '#theme' => 'image',
        '#alt' => (isset($item['title'])) ? $item['title'] : '',
        '#title' => (isset($item['title'])) ? $item['title'] : '',
        '#path' => $item['url'],
      );      
    }
  }
  return $elements;
}

/**
 * Implements hook_cron
 */
function slac_igp_email_cron() {
  // Implementing a simple cron that will re-subscribe people to the weekly email
  $listid = variable_get('mailchimp_list_sync_list', '');
  if ($listid === '') {
    return;
  }
  $mcapi = mailchimp_get_api_object();
  $ret = $mcapi->listMembers($listid, 'unsubscribed');   
  if (empty($ret['data'])) {
    return;
  }
  // re-subscribe to user
  // declare an rules event
  foreach ($ret['data'] as $item) {
    $ret = $mcapi->listSubscribe($listid, $item['email'], array(), 'html', FALSE, FALSE, FALSE, FALSE);
    if (!$ret) {
      watchdog('slac_igp_email', 'MCAPI Error when calling listSubscribe on %email, Error code: %errcode, Error message: %errmsg', array('%email' => $item['email'], '%errcode' => $mcapi->errorCode,'%errmsg' => $mcapi->errorMessage), WATCHDOG_ERROR);
      return;
    }
    // invoke a rules component
    rules_invoke_component('rules_slac_igp_email_resubscription', $item['email']);
  }
}

/**
 * Implements hook_theme
 */
function slac_igp_email_theme() {
  return array(
    'slac_igp_email_sidebar' => array(
      'variables' => array(
        'events' => NULL,
        'access' => NULL,
        'flea_market' => NULL,
      ),
      'template' => 'slac_igp_email_sidebar',
    ),
    'slac_igp_email' => array(
      'variables' => array(
        'featured_news' => NULL,
        'news' => NULL,
      ),
      'template' => 'slac_igp_email',
    ),
    'slac_igp_director_column' => array(
      'variables' => array(
        'directors_column' => NULL,
      ),
      'template' => 'slac_igp_director_column',
    ),
    'slac_igp_email_title' => array(
      'variables' => array(
        'type' => NULL,
      ),
    ),
  ); 
}

/**
 * Implements hook_form_FORM_ID_alter
 */
function slac_igp_email_form_mailchimp_lists_user_subscribe_form_daily_email_alter(&$form, &$form_state, $form_id) {
  $form['submit']['#value'] = t('Subscribe');
  hide($form['mailchimp_lists']['mailchimp_daily_email']['title']);
  hide($form['mailchimp_lists']['mailchimp_daily_email']['mergevars']['FNAME']);
  hide($form['mailchimp_lists']['mailchimp_daily_email']['mergevars']['LNAME']);
}

/**
 * Implements hook_mailchimp_dc_content
 */
function slac_igp_email_mailchimp_dc_content($template_sections = array()) {
  
  // declare contents in the daily digest  
  $data['SLAC_DD'] = array(
    'module' => 'slac_igp_email',
    'title' => t('SLAC daily digest'),
    'content' => _slac_igp_email_mailchimp_dc_content($template_sections),
  );
  
  // declare contents in the weekly digest
  $data['SLAC_WD'] = array(
    'module' => 'slac_igp_email',
    'title' => t('SLAC weekly digest'),
    'content' => _slac_igp_email_mailchimp_weekly_content($template_sections),
  );
  
  return $data;
}

/**
 * Theme function 
 */
function theme_slac_igp_email_title($vars) {
  return '<h2>' . date('F j, Y') . '<br />' . $vars['type'] . ' Email</h2>';
}

/**
 * Return contents to the mailchimp templates for weekly email
 */
function _slac_igp_email_mailchimp_weekly_content($template_sections) {
  //@todo: iterate through the template_sections
  return array(
    'html_director_column' => array(
      'value' => theme('slac_igp_director_column'),
      'format' => 'mailchimp_campaign',
    ),
    'html_std_header_title' => array(
      'value' => theme('slac_igp_email_title', array('type' => 'Weekly')),
      'format' => 'mailchimp_campaign',
    ),
  );
}

/**
 * Return contents to the mailchimp templates
 */
function _slac_igp_email_mailchimp_dc_content($template_sections) {
  //@todo: iterate through the template_sections
  return array(
    'html_sidebar' => array(
      'value' => theme('slac_igp_email_sidebar'),
      'format' => 'mailchimp_campaign',
    ),
    'html_news' => array(
      'value' => theme('slac_igp_email'),
      'format' => 'mailchimp_campaign',
    ),
    'html_std_header_title' => array(
      'value' => theme('slac_igp_email_title', array('type' => 'Daily')),
      'format' => 'mailchimp_campaign',
    ),
  );
}

/**
 * Preprocess function, finds and add director's column
 */
function slac_igp_email_preprocess_slac_igp_director_column(&$vars) {
  // director's column is an news article tagged with "Director's Column"
  $term = taxonomy_get_term_by_name(strtolower(DIRECTOR_COLUMN));
  if (!empty($term)) {
    $keys = array_keys($term);
    $tid = $keys[0];
  }
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'news_article')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_tags', 'tid', $tid)
    ->propertyOrderBy('created', 'DESC')
    ->range(0, 1);
  $result = $query->execute();
  
  if (!empty($result)) {
    $node = current($result['node']);
    $vars['director_column'] = '[mailchimp_campaign|entity_type=node|entity_id=' . $node->nid . '|view_mode=teaser]';
  }  
}

/**
 * Preprocess function
 */
function slac_igp_email_preprocess_slac_igp_email_sidebar(&$vars) {
  // provide dynamic sidebar items
  $vars['events'] = views_embed_view('email_events', 'block');
  $vars['access'] = views_embed_view('email_access_information', 'block');
  $vars['flea_market'] = views_embed_view('email_flea_market', 'block');
}

/**
 * Preprocess function, providing main contents for the email
 */
function slac_igp_email_preprocess_slac_igp_email(&$vars) {
  if (!module_exists('slac_igp_feed')) {
    return;
  }
  module_load_include('inc', 'slac_igp_feed', 'slac_igp_feed.nodequeue');
  
  // initiate empty arrays
  $vars['featured_news'] = array();
  $vars['news'] = array();
  
  // load everything in the featured news
  $output_array = array();
  $subqueues = array(FEATURED_NEWS, LAB_NEWS, SLAC_SCIENCE);
  foreach ($subqueues as $subqueue_name) {
    $subqueue = slac_igp_feed_get_subqueue($subqueue_name);
    switch ($subqueue_name) {
      case FEATURED_NEWS:
        $count = 5;
        $mode = VIEW_MODE_TEASER;
        $name = 'featured_news';
      break;
      case LAB_NEWS:
      case SLAC_SCIENCE:
        $count = 10;
        $mode = VIEW_MODE_LINK;
        $name = 'news';
      break;
    }
    // load nodes
    $nodes = nodequeue_load_nodes($subqueue->sqid, FALSE, 0, $count, TRUE);
    if (!empty($nodes)) {
      foreach ($nodes as $node) {
        // filter nodes by published date, for daily email we only want contents imported today
        $created_date = date('Y-m-d', $node->created);
        $now = date('Y-m-d', REQUEST_TIME);
        if ($created_date == $now) {
          $vars[$name][] = '[mailchimp_campaign|entity_type=node|entity_id=' . $node->nid . '|view_mode=' . $mode . ']';
        }  
      }
    }
  }
}